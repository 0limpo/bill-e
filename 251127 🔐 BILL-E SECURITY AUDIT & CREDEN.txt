# ğŸ” BILL-E SECURITY AUDIT & CREDENTIAL ROTATION
================================================================================
FECHA: 27 Noviembre 2025
PRIORIDAD: CRÃTICA - EJECUTAR INMEDIATAMENTE
================================================================================

## ğŸš¨ SITUACIÃ“N ACTUAL CRÃTICA

SegÃºn el anÃ¡lisis, las **credenciales de Google Cloud estÃ¡n expuestas en el repositorio**:
- Archivo: `backend/bill-e-ocr-bce903295fd1.json`
- Riesgo: Acceso no autorizado a Google Cloud Vision API
- Impacto: Costos elevados, breach de datos, suspensiÃ³n del servicio

## âš¡ PLAN DE ACCIÃ“N INMEDIATA (HOY)

### PASO 1: ASSESSMENT COMPLETO (30 minutos)
```bash
# 1. Revisar quÃ© estÃ¡ expuesto en el repo
git log --oneline | head -20
git show --name-only

# 2. Buscar todas las credenciales expuestas
grep -r "private_key" .
grep -r "client_secret" .  
grep -r "project_id" .
grep -r "redis" .
grep -r "whatsapp" .

# 3. Verificar historial de commits
git log --all --grep="credential"
git log --all --grep="key"
```

### PASO 2: ROTACIÃ“N INMEDIATA (Google Cloud)

#### A. Acceder a Google Cloud Console
1. Ve a: https://console.cloud.google.com/
2. Proyecto: `bill-e-ocr` (o el nombre que uses)
3. Navega a: IAM & Admin â†’ Service Accounts

#### B. Crear nueva Service Account
```bash
# Comando alternativo si prefieres CLI
gcloud iam service-accounts create bill-e-prod \
    --description="Bill-e production OCR service" \
    --display-name="Bill-e Production"

# Asignar permisos
gcloud projects add-iam-policy-binding PROJECT_ID \
    --member="serviceAccount:bill-e-prod@PROJECT_ID.iam.gserviceaccount.com" \
    --role="roles/vision.imageAnnotator"
```

#### C. Generar nueva clave
1. Click en la service account nueva
2. Keys â†’ Add Key â†’ Create New Key
3. Formato: JSON
4. **DESCARGAR pero NO commitear al repo**

#### D. Desactivar clave antigua
1. Encontrar la service account actual
2. Keys â†’ encontrar la key expuesta
3. **Delete** la clave comprometida
4. Confirmar que OCR deja de funcionar (para verificar)

### PASO 3: SETUP SEGURO DE VARIABLES DE ENTORNO

#### A. Render (Backend)
1. Ve a: https://dashboard.render.com/
2. Tu servicio `bill-e-backend`
3. Environment â†’ Add Environment Variable

```bash
# Variables crÃ­ticas para agregar:
GOOGLE_APPLICATION_CREDENTIALS_JSON='{toda_la_nueva_key_json_aqui}'
REDIS_URL=rediss://default:password@host:6379
WHATSAPP_ACCESS_TOKEN=EAA...
WHATSAPP_PHONE_NUMBER_ID=123...
WHATSAPP_VERIFY_TOKEN=tu_token
```

#### B. Local Development (.env)
```bash
# Crear archivo .env en backend/ (si no existe)
cd backend
touch .env

# AÃ±adir al .env (NO commitear):
GOOGLE_APPLICATION_CREDENTIALS_JSON='{"type":"service_account",...}'
REDIS_URL="rediss://default:password@host:6379"
WHATSAPP_ACCESS_TOKEN="EAA..."
WHATSAPP_PHONE_NUMBER_ID="123..."
WHATSAPP_VERIFY_TOKEN="tu_token_secreto"
```

#### C. Actualizar .gitignore
```bash
# Verificar que estos estÃ©n en .gitignore:
.env
*.json
credentials/
keys/
secrets/
```

### PASO 4: LIMPIAR HISTORIAL DE GIT (CRÃTICO)

#### OpciÃ³n A: BFG Repo Cleaner (Recomendado)
```bash
# Instalar BFG
# Mac: brew install bfg
# Windows: descargar desde https://rtyley.github.io/bfg-repo-cleaner/

# Backup del repo
git clone --mirror https://github.com/0limpo/bill-e.git bill-e-backup.git

# Limpiar archivos JSON del historial
bfg --delete-files "*.json" bill-e-backup.git
cd bill-e-backup.git
git reflog expire --expire=now --all && git gc --prune=now --aggressive

# Push force (PELIGROSO - hacer backup antes)
git push --force
```

#### OpciÃ³n B: git filter-branch (Manual)
```bash
# PELIGROSO: Reescribe todo el historial
git filter-branch --force --index-filter \
'git rm --cached --ignore-unmatch backend/bill-e-ocr-*.json' \
--prune-empty --tag-name-filter cat -- --all
```

#### OpciÃ³n C: Nuevo repo (MÃ¡s seguro)
```bash
# Si el historial es corto, crear repo nuevo:
mkdir bill-e-clean
cd bill-e-clean
git init
# Copiar solo archivos necesarios (sin credenciales)
# Commit inicial limpio
# Configurar como nuevo remote
```

### PASO 5: VERIFICAR ROTACIÃ“N EXITOSA

```bash
# 1. Test local
cd backend
python test_redis.py
python test_session.py

# 2. Test producciÃ³n
curl https://bill-e-backend-lfwp.onrender.com/health

# 3. Test OCR
# Subir imagen de prueba y verificar que funciona
```

### PASO 6: OTRAS CREDENCIALES A REVISAR

#### WhatsApp (si estÃ¡n expuestas)
1. Meta Developers: https://developers.facebook.com/
2. Regenerar Access Token
3. Cambiar Verify Token
4. Actualizar webhook URL si es necesario

#### Upstash Redis (verificar)
1. https://console.upstash.com/
2. Database â†’ Details
3. Regenerar password si es necesario

#### Render
1. Cambiar deploy key si estÃ¡ expuesto
2. Rotar API keys si aplica

## ğŸ›¡ï¸ MEJORAS DE SEGURIDAD A IMPLEMENTAR

### INMEDIATAS (Hoy)
â–¡ Rotar todas las credenciales expuestas
â–¡ Configurar variables de entorno en Render
â–¡ Limpiar historial de Git
â–¡ Verificar .gitignore actualizado

### ESTA SEMANA
â–¡ Implementar rate limiting por IP
â–¡ Agregar request logging
â–¡ Setup monitoring de costos Google Cloud
â–¡ Configurar alertas de uso anÃ³malo

### PRÃ“XIMA SEMANA
â–¡ Audit de dependencias (vulnerabilidades)
â–¡ HTTPS enforcement
â–¡ Input validation mejorada
â–¡ Security headers

## ğŸ“Š MONITOREO POST-ROTACIÃ“N

### MÃ©tricas a vigilar (24-48 horas):
- **Google Cloud Vision**: Requests, errores, costos
- **Upstash Redis**: Connections, commands
- **Render**: Response times, error rates
- **WhatsApp**: Message delivery rates

### Alertas a configurar:
- Google Cloud: >$10 USD/dÃ­a
- Redis: >80% memory usage
- API: >5% error rate
- Unusual access patterns

## ğŸš¨ CHECKLIST DE EMERGENCIA

Si algo sale mal durante la rotaciÃ³n:
â–¡ Revertir a credenciales backup temporalmente
â–¡ Verificar logs de errores en Render
â–¡ Contactar soporte de servicios si es necesario
â–¡ Documentar issues para post-mortem

## â° TIMELINE DE EJECUCIÃ“N

**HOY (2-3 horas):**
- [ ] 30min: Assessment completo
- [ ] 60min: Rotar Google Cloud credenciales
- [ ] 30min: Configurar variables entorno Render
- [ ] 30min: Verificar funcionamiento
- [ ] 30min: Limpiar repo (mÃ©todo seguro)

**MAÃ‘ANA:**
- [ ] Verificar mÃ©tricas 24h
- [ ] Confirmar no hay costos anÃ³malos
- [ ] Documentar cambios realizados

## ğŸ“ DOCUMENTACIÃ“N POST-ROTACIÃ“N

Crear archivo `SECURITY.md` con:
- Inventory de credenciales y dÃ³nde estÃ¡n
- Proceso de rotaciÃ³n para futuro
- Contactos de emergencia
- Logs de cambios realizados

================================================================================

## âš¡ EJECUTAR AHORA - ORDEN DE PRIORIDAD:

1. ğŸ”´ **IMMEDIATAMENTE**: Assessment + backup repo
2. ğŸ”´ **EN 1 HORA**: Rotar Google Cloud credentials  
3. ğŸŸ¡ **EN 2 HORAS**: Variables entorno + test funcionamiento
4. ğŸŸ¡ **EN 3 HORAS**: Limpiar historial Git
5. ğŸŸ¢ **MAÃ‘ANA**: Monitoreo y documentaciÃ³n

================================================================================

Â¿EMPEZAMOS AHORA CON EL PASO 1 (ASSESSMENT)?